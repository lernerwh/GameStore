import { SnakeViewModel } from '../games/snake/viewmodel/SnakeViewModel';
import { SnakeRenderer } from '../games/snake/view/SnakeRenderer';
import { SnakeState } from '../games/snake/model/SnakeState';
import { SnakeConstants } from '../games/snake/model/SnakeConstants';
import { router } from '@kit.ArkUI';

@Entry
@Component
struct SnakeGame {
  @State isPlaying: boolean = false;
  @State viewModel: SnakeViewModel = new SnakeViewModel();
  private renderer: SnakeRenderer = new SnakeRenderer();
  private settings: RenderingContextSettings = new RenderingContextSettings(true);
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings);
  private gameInterval: number | null = null;
  private touchStartX: number = 0;
  private touchStartY: number = 0;

  aboutToDisappear(): void {
    this.cleanup();
  }

  build() {
    Column() {
      if (!this.isPlaying) {
        this.HomeView();
      } else {
        this.GameView();
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  HomeView() {
    Column() {
      // ËøîÂõûÊåâÈíÆ
      Row() {
        Button() {
          Text('‚Üê ËøîÂõû')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .backgroundColor('rgba(255,255,255,0.1)')
        .borderRadius(20)
        .height(36)
        .padding({ left: 15, right: 15 })
        .onClick(() => { router.back(); })
      }
      .width('100%')
      .padding({ left: 20, top: 50 })

      Text('Ë¥™ÂêÉËõá')
        .fontSize(42)
        .fontWeight(FontWeight.Bold)
        .fontColor('#4ade80')
        .textShadow({ radius: 10, color: '#22c55e', offsetX: 0, offsetY: 0 })
        .margin({ top: 30, bottom: 20 })

      Text('üêç')
        .fontSize(80)
        .margin({ bottom: 30 })

      Text('ÁªèÂÖ∏Ë°óÊú∫Ê∏∏Êàè')
        .fontSize(18)
        .fontColor('#AAAAAA')
        .margin({ bottom: 10 })

      Text('ÂêÉÊéâÈ£üÁâ©Ôºå‰∏çÊñ≠ÊàêÈïø!')
        .fontSize(16)
        .fontColor('#888888')
        .margin({ bottom: 50 })

      Column() {
        Text('Ê∏∏ÊàèËßÑÂàô:')
          .fontSize(16)
          .fontColor('#FFFFFF')
          .margin({ bottom: 15 })

        Text('‚Ä¢ ÊªëÂä®Â±èÂπïÊéßÂà∂ÊñπÂêë')
          .fontSize(14)
          .fontColor('#CCCCCC')
          .margin({ bottom: 8 })

        Text('‚Ä¢ ÂêÉÊéâÁ∫¢Ëâ≤È£üÁâ©ÂæóÂàÜ')
          .fontSize(14)
          .fontColor('#ef4444')
          .margin({ bottom: 8 })

        Text('‚Ä¢ ‰∏çË¶ÅÊíûÂ¢ôÊàñÊíûÂà∞Ëá™Â∑±')
          .fontSize(14)
          .fontColor('#FF6B6B')
          .margin({ bottom: 8 })

        Text('‚Ä¢ ËõáË∂äÈïøÔºåÊåëÊàòË∂äÂ§ß!')
          .fontSize(14)
          .fontColor('#4ade80')
          .margin({ bottom: 20 })
      }
      .padding(20)
      .backgroundColor('rgba(255,255,255,0.1)')
      .borderRadius(15)
      .margin({ bottom: 40 })

      Button('ÂºÄÂßãÊ∏∏Êàè')
        .fontSize(22)
        .fontColor('#FFFFFF')
        .backgroundColor('#22c55e')
        .borderRadius(30)
        .width(180)
        .height(50)
        .shadow({ radius: 15, color: '#22c55e', offsetX: 0, offsetY: 5 })
        .onClick(() => { this.startGame(); })
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#0a1628', 0.0], ['#1a3a2a', 0.5], ['#0d2820', 1.0]]
    })
  }

  @Builder
  GameView() {
    Column() {
      Canvas(this.canvasContext)
        .width(SnakeConstants.CANVAS_WIDTH)
        .height(SnakeConstants.CANVAS_HEIGHT)
        .backgroundColor(SnakeConstants.COLOR_BACKGROUND)
        .onReady(() => { this.onCanvasReady(); })
        .onClick((event) => { this.onCanvasClick(event); })
        .onTouch((event) => { this.onCanvasTouch(event); })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#0a1628')
  }

  private startGame(): void {
    this.isPlaying = true;
    this.viewModel = new SnakeViewModel();
  }

  private onCanvasReady(): void {
    if (this.gameInterval !== null) {
      clearInterval(this.gameInterval);
    }
    this.gameInterval = setInterval(() => {
      this.gameLoop();
    }, SnakeConstants.GAME_SPEED);
  }

  private gameLoop(): void {
    this.viewModel.update();
    this.renderer.render(
      this.canvasContext,
      this.viewModel.snake,
      this.viewModel.food,
      this.viewModel.score,
      this.viewModel.gameState
    );
  }

  private onCanvasClick(event: ClickEvent): void {
    const state = this.viewModel.gameState;
    if (state === SnakeState.IDLE) {
      this.viewModel.startGame();
    } else if (state === SnakeState.GAME_OVER) {
      this.viewModel.startGame();
    }
  }

  private onCanvasTouch(event: TouchEvent): void {
    if (event.type === TouchType.Down) {
      this.touchStartX = event.touches[0].x;
      this.touchStartY = event.touches[0].y;

      // ÁÇπÂáªÂºÄÂßãÊ∏∏Êàè
      if (this.viewModel.gameState === SnakeState.IDLE) {
        this.viewModel.startGame();
      }
    } else if (event.type === TouchType.Up) {
      const endX = event.touches[0].x;
      const endY = event.touches[0].y;
      this.viewModel.handleSwipe(this.touchStartX, this.touchStartY, endX, endY);
    }
  }

  private cleanup(): void {
    if (this.gameInterval !== null) {
      clearInterval(this.gameInterval);
      this.gameInterval = null;
    }
    this.viewModel.destroy();
  }
}
