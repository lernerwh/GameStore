import { GameViewModel } from '../games/flappybird/viewmodel/GameViewModel';
import { GameRenderer } from '../games/flappybird/view/GameRenderer';
import { ScoreRepository } from '../games/flappybird/model/ScoreRepository';
import { GameState } from '../games/flappybird/model/GameState';
import { GameConstants } from '../games/flappybird/model/GameConstants';
import { common } from '@kit.AbilityKit';
import { router } from '@kit.ArkUI';

/**
 * Flappy Bird æ¸¸æˆé¡µé¢
 */
@Entry
@Component
struct FlappyBirdGame {
  // é¡µé¢çŠ¶æ€
  @State isPlaying: boolean = false;
  @State highScore: number = 0;

  // æ¸¸æˆç›¸å…³
  @State viewModel: GameViewModel = new GameViewModel();
  private renderer: GameRenderer = new GameRenderer();
  private scoreRepository: ScoreRepository | null = null;

  // Canvasç›¸å…³
  private settings: RenderingContextSettings = new RenderingContextSettings(true);
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings);
  private renderInterval: number | null = null;

  aboutToAppear(): void {
    this.initScoreRepository();
  }

  aboutToDisappear(): void {
    this.cleanup();
  }

  build() {
    Column() {
      if (!this.isPlaying) {
        // é¦–é¡µç•Œé¢
        this.HomeView();
      } else {
        // æ¸¸æˆç•Œé¢
        this.GameView();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é¦–é¡µè§†å›¾
   */
  @Builder
  HomeView() {
    Column() {
      // è¿”å›æŒ‰é’®
      Row() {
        Button() {
          Text('â† è¿”å›')
            .fontSize(16)
            .fontColor('#FFFFFF')
        }
        .backgroundColor('rgba(0,0,0,0.2)')
        .borderRadius(20)
        .height(36)
        .padding({ left: 15, right: 15 })
        .onClick(() => { router.back(); })
      }
      .width('100%')
      .padding({ left: 20, top: 50 })

      // æ ‡é¢˜
      Text('Flappy Bird')
        .fontSize(48)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFD700')
        .textShadow({
          radius: 4,
          color: '#000000',
          offsetX: 2,
          offsetY: 2
        })
        .margin({ top: 30, bottom: 20 })

      // å°é¸Ÿå›¾æ ‡
      Text('ğŸ¦')
        .fontSize(80)
        .margin({ bottom: 40 })

      // æœ€é«˜åˆ†
      Text(`æœ€é«˜åˆ†: ${this.highScore}`)
        .fontSize(24)
        .fontColor('#333333')
        .margin({ bottom: 40 })

      // å¼€å§‹æ¸¸æˆæŒ‰é’®
      Button('å¼€å§‹æ¸¸æˆ')
        .fontSize(24)
        .fontColor('#FFFFFF')
        .backgroundColor('#228B22')
        .borderRadius(25)
        .width(200)
        .height(50)
        .onClick(() => {
          this.startGame();
        })

      // è¯´æ˜æ–‡å­—
      Text('ç‚¹å‡»å±å¹•è®©å°é¸Ÿè·³è·ƒ\né¿å¼€ç®¡é“è·å¾—åˆ†æ•°')
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .margin({ top: 40 })
        .lineHeight(24)
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 180,
      colors: [['#87CEEB', 0.0], ['#98FB98', 1.0]]
    })
  }

  /**
   * æ¸¸æˆè§†å›¾
   */
  @Builder
  GameView() {
    Column() {
      // æ¸¸æˆç”»å¸ƒ
      Canvas(this.canvasContext)
        .width(GameConstants.CANVAS_WIDTH)
        .height(GameConstants.CANVAS_HEIGHT)
        .backgroundColor(GameConstants.COLOR_SKY)
        .onReady(() => {
          this.onCanvasReady();
        })
        .onClick(() => {
          this.onCanvasClick();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#333333')
  }

  /**
   * åˆå§‹åŒ–åˆ†æ•°ä»“åº“
   */
  private async initScoreRepository(): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      this.scoreRepository = new ScoreRepository(context);
      await this.scoreRepository.init();
      this.highScore = await this.scoreRepository.getHighScore();
    } catch (error) {
      console.error('Failed to init score repository:', error);
    }
  }

  /**
   * å¼€å§‹æ¸¸æˆ
   */
  private startGame(): void {
    this.isPlaying = true;
    this.viewModel = new GameViewModel();
  }

  /**
   * Canvaså‡†å¤‡å®Œæˆ
   */
  private onCanvasReady(): void {
    this.startRenderLoop();
  }

  /**
   * Canvasç‚¹å‡»äº‹ä»¶
   */
  private onCanvasClick(): void {
    const gameState = this.viewModel.gameState;

    if (gameState === GameState.IDLE) {
      this.viewModel.startGame();
    } else if (gameState === GameState.PLAYING) {
      this.viewModel.jump();
    } else if (gameState === GameState.GAME_OVER) {
      this.handleGameOver();
    }
  }

  /**
   * å¤„ç†æ¸¸æˆç»“æŸ
   */
  private async handleGameOver(): Promise<void> {
    // ä¿å­˜åˆ†æ•°
    if (this.scoreRepository) {
      const score = this.viewModel.score;
      const isNewHighScore = await this.scoreRepository.saveHighScore(score);
      if (isNewHighScore) {
        this.highScore = score;
      }
    }

    // è¿”å›é¦–é¡µ
    this.cleanup();
    this.isPlaying = false;
  }

  /**
   * å¼€å§‹æ¸²æŸ“å¾ªç¯
   */
  private startRenderLoop(): void {
    if (this.renderInterval !== null) {
      clearInterval(this.renderInterval);
    }

    this.renderInterval = setInterval(() => {
      this.render();
    }, 1000 / 60);
  }

  /**
   * æ¸²æŸ“æ¸¸æˆç”»é¢
   */
  private render(): void {
    this.renderer.render(
      this.canvasContext,
      this.viewModel.bird,
      this.viewModel.pipes,
      this.viewModel.score,
      this.viewModel.gameState,
      this.viewModel.groundY
    );
  }

  /**
   * æ¸…ç†èµ„æº
   */
  private cleanup(): void {
    if (this.renderInterval !== null) {
      clearInterval(this.renderInterval);
      this.renderInterval = null;
    }
    this.viewModel.destroy();
  }
}
